!function(t){if("object"==typeof exports)module.exports=t();else if("function"==typeof define&&define.amd)define(t);else{var e;"undefined"!=typeof window?e=window:"undefined"!=typeof global?e=global:"undefined"!=typeof self&&(e=self),e.MMLEmitter=t()}}(function(){return function t(e,n,r){function i(c,u){if(!n[c]){if(!e[c]){var s="function"==typeof require&&require;if(!u&&s)return s(c,!0);if(o)return o(c,!0);throw new Error("Cannot find module '"+c+"'")}var a=n[c]={exports:{}};e[c][0].call(a.exports,function(t){var n=e[c][1][t];return i(n?n:t)},a,a.exports,t,e,n,r)}return n[c].exports}for(var o="function"==typeof require&&require,c=0;c<r.length;c++)i(r[c]);return i}({1:[function(t,e){e.exports=t("./src/")},{"./src/":6}],2:[function(t,e){"use strict";function n(){this._callbacks={}}n.prototype.hasListeners=function(t){return this._callbacks.hasOwnProperty(t)},n.prototype.listeners=function(t){return this.hasListeners(t)?this._callbacks[t].slice():[]},n.prototype.on=function(t,e){return this.hasListeners(t)||(this._callbacks[t]=[]),this._callbacks[t].push(e),this},n.prototype.addListener=n.prototype.on,n.prototype.once=function(t,e){function n(r){this.off(t,n),e.call(this,r)}return n.listener=e,this.on(t,n),this},n.prototype.off=function(t,e){return"undefined"==typeof e?"undefined"==typeof t?this._callbacks={}:this.hasListeners(t)&&delete this._callbacks[t]:this.hasListeners(t)&&(this._callbacks[t]=this._callbacks[t].filter(function(t){return!(t===e||t.listener===e)})),this},n.prototype.removeListener=n.prototype.off,n.prototype.removeAllListeners=n.prototype.off,n.prototype.emit=function(t,e){this.listeners(t).forEach(function(t){t.call(this,e)},this)},e.exports=n},{}],3:[function(t,e){"use strict";function n(t){return"$"===t.charAt(0)}function r(t){return!this.hasOwnProperty(t)}function i(t){var e=t.substr(1);Object.defineProperty(this,t,{get:function(){return this._shared&&this._shared[e]||null},set:function(t){this._shared&&(this._shared[e]=t)}})}function o(t,e){var o;try{o=new Function("return "+e.expr+";")}catch(c){throw new Error("Error parsing expression: "+e.expr)}return e.variables.filter(n).filter(r,t).forEach(i,t),{valueOf:function(t){var e=o.call(t);return"number"==typeof e?e:null}}}e.exports.compile=o},{}],4:[function(t,e){"use strict";function n(t){return t[t.length-1]}function r(t){return-1!==o.indexOf(t)}function i(t){function e(){return t.scan(/[_$a-zA-Z][_$\w]*/)}function i(){return t.scan(/('|").*?\1/)}function o(){return t.scan(/\d+\.?\d*(e[-+]?\d+)?|0x[\da-f]+/i)}function u(){return t.next()+e()}function s(){function a(){var i=e();if(r(i))throw new SyntaxError("Statements should not be used in directives: "+i);if("}"===n(h)){t.scan(/\s*/),t.expect(":");var o=s();return[].push.apply(p,o.variables),i+":"+o.expr}return/^([A-Z]\w*|\$|_|true|false|null)$/.test(i)||(p.push(i),i="this."+i),i}function f(){if(!t.hasNext())return!1;var e=t.peek();switch(e){case"{":case"(":case"[":h.push(c[e]);break;case"]":case")":case"}":if(0===h.length)return!1;h.pop()!==e&&t.throwUnexpectedToken()}return!0}for(var p=[],h=[],l="";f();){var d=t.peek();l+="'"===d||'"'===d?i():d>="0"&&"9">=d?o():"."===d?u():/[_$a-zA-Z]/.test(d)?a():t.next()}return{expr:l,variables:p}}return s()}var o=["break","case","catch","continue","debugger","default","delete","do","else","finally","for","function","if","in","instanceof","new","return","switch","this","throw","try","typeof","var","void","while","with","undefined","abstract","boolean","byte","char","class","const","double","enum","export","extends","final","float","goto","implements","import","int","interface","long","native","package","private","protected","public","short","static","super","synchronized","throws","transient","volatile","arguments","let","yield"],c={"{":"}","(":")","[":"]"};e.exports.parse=i},{}],5:[function(t,e){"use strict";e.exports=function(t,e){t.prototype=Object.create(e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}})}},{}],6:[function(t,e){"use strict";var n=t("./mml-emitter");n.version="0.2.0",e.exports=n},{"./mml-emitter":8}],7:[function(t,e){"use strict";function n(t){return t[t.length-1]}function r(t,e,n){return Math.max(e,Math.min(t,n))}function i(t,e){return t+e}function o(t,e,n){return null!==e&&(e=e.valueOf(t)),null===e?n:e}function c(t,e){var n=null,c=0;return null===e[0]&&(e=t._lenList.concat(e.slice(1))),e.map(function(e){return null===e?e=n:0===e?e=c=2*c:n=c=e,60/t._tempo*(4/r(o(t,e,4),1,1920))}).reduce(i,0)}function u(t,e){if(e&&"object"==typeof e){if(e.type===f.Expression)return a.compile(t,e);if(Array.isArray(e))return e.map(function(e){return u(t,e)});Object.keys(e).forEach(function(n){e[n]=u(t,e[n])})}return e}function s(t,e){return[].concat({type:f.Begin},e,{type:f.End}).map(function(e,n){return e=u(t,e),s[e.type](e,n)})}var a=t("./expr-compiler"),f=t("./syntax");s[f.Begin]=function(){return function(t,e){return t._tempo=120,t._octave=5,t._quantize=6,t._velocity=12,t._length=4,t._lenList=[t._length],t._loopStack=[],t._infLoopIndex=null,t._infLoopWhen=e,e}},s[f.End]=function(){return function(t,e){return null!==t._infLoopIndex?t._infLoopWhen!==e&&(t._index=t._infLoopIndex):t._recv({type:"end",when:e},{bubble:!0}),e}},s[f.Note]=function(t){return function(e,n){var r=c(e,t.length),i=r*(e._quantize/8),o=e._velocity;return t.number.forEach(function(t,r){function c(t,r){e._recv({type:"sched",when:n+i+(r||0),callback:t},{"private":!0})}var u=12*e._octave+t+12;e._recv({type:"note",when:n,midi:u,duration:i,noteOff:c,chordIndex:r,velocity:o})}),n+r}},s[f.Octave]=function(t){return function(e,n){return e._octave=r(o(e,t.value,5),0,8),n}},s[f.OctaveShift]=function(t){return function(e,n){var i=e._octave+t.direction*o(e,t.value,1);return e._octave=r(i,0,8),n}},s[f.Length]=function(t){return function(e,n){return e._length=t.length[0],e._lenList=t.length,n}},s[f.Quantize]=function(t){return function(e,n){return e._quantize=r(o(e,t.value,6),0,8),n}},s[f.Tempo]=function(t){return function(e,n){return e._tempo=r(o(e,t.value,120),1,511),n}},s[f.Velocity]=function(t){return function(e,n){return e.velocity=r(o(e,t.value,12),0,16),n}},s[f.InfLoop]=function(t,e){return function(t,n){return t._infLoopIndex=e,t._infLoopWhen=n,n}},s[f.LoopBegin]=function(t,e){return function(n,i){return n._loopStack.push([r(o(n,t.value,2),1,999),e,null]),i}},s[f.LoopExit]=function(){return function(t,e){var r=n(t._loopStack);return r[0]<=1&&null!==r[2]&&(t._index=r[2]),e}},s[f.LoopEnd]=function(t,e){return function(t,r){var i=n(t._loopStack);return null===i[2]&&(i[2]=e),i[0]-=1,i[0]>0?t._index=i[1]:t._loopStack.pop(),r}},s[f.Command]=function(t){return function(e,n){return o(e,t.value,0),n}},e.exports.compile=s},{"./expr-compiler":3,"./syntax":12}],8:[function(t,e){"use strict";function n(t,e){u.call(this),this.audioContext=t,this.tracks=o.parse(e).map(function(t){return new c(this,t)},this),this._ended=0,this._node=null,this._currentTime=0,this._currentTimeIncr=0}var r=512,i=t("./extend"),o=t("./mml-parser"),c=t("./mml-track"),u=t("./emitter");i(n,u),n.prototype.start=function(){this.stop();var t=this.audioContext.currentTime,e=r/this.audioContext.sampleRate;return this.tracks.forEach(function(n){n._init(t,e)},this),this._node=this.audioContext.createScriptProcessor(r,1,1),this._node.onaudioprocess=this._process.bind(this),this._node.connect(this.audioContext.destination),this},n.prototype.stop=function(){return this._node&&this._node.disconnect(),this._node=null,this},n.prototype._recv=function(t){t&&"end"===t.type&&(this._ended+=1,this.tracks.length<=this._ended&&this.emit("end",t))},n.prototype._process=function(){var t=this.audioContext.currentTime;this.tracks.forEach(function(e){e._process(t)})},e.exports=n},{"./emitter":2,"./extend":5,"./mml-parser":9,"./mml-track":10}],9:[function(t,e){"use strict";function n(t,e){return Array.isArray(e)?Array.prototype.push.apply(t,e):e&&t.push(e),t}function r(t){function e(e,n){for(;;){if(t.forward(),!t.hasNext()||t.match(e))break;n()}}function r(e){return{c:0,d:2,e:4,f:5,g:7,a:9,b:11}[t.next()]+u()+e}function i(){for(var e=(t.scan(/\.+/)||"").length,n=new Array(e),r=0;e>r;r++)n[r]=0;return n}function u(){return t.match("+")?(t.next(),1):t.match("-")?(t.next(),-1):0}function s(){return n([a(/\d+/)].concat(i()),f())}function a(e){if(t.match("("))return L();var n=t.scan(e);return null!==n?+n:null}function f(){return t.forward(),t.match("^")?(t.next(),s(null)):null}function p(){return{type:c.Note,number:[r(0)],length:s()}}function h(){t.expect("[");var n=[],i=0;return e("]",function(){switch(t.peek()){case"c":case"d":case"e":case"f":case"g":case"a":case"b":n.push(r(i));break;case"<":t.next(),i+=12;break;case">":t.next(),i-=12;break;default:t.throwUnexpectedToken()}}),t.expect("]"),{type:c.Note,number:n,length:s()}}function l(){return t.expect("r"),{type:c.Note,number:[],length:s()}}function d(){return t.expect("o"),{type:c.Octave,value:a(/\d+/)}}function x(e){return t.expect(/<|>/),{type:c.OctaveShift,direction:0|e,value:a(/\d+/)}}function v(){return t.expect("l"),{type:c.Length,length:s()}}function _(){return t.expect("q"),{type:c.Quantize,value:a(/\d+/)}}function y(){return t.expect("t"),{type:c.Tempo,value:a(/\d+(\.\d+)?/)}}function m(){return t.expect("v"),{type:c.Velocity,value:a(/\d+/)}}function b(){return t.expect("$"),{type:c.InfLoop}}function g(){t.expect("/"),t.expect(":");var r=[{type:c.LoopBegin}];return e(/[|:]/,function(){n(r,E())}),n(r,w()),t.expect(":"),t.expect("/"),r.push({type:c.LoopEnd}),r[0].value=a(/\d+/)||2,r}function w(){var r=[];return t.match("|")&&(t.next(),r.push({type:c.LoopExit}),e(":",function(){n(r,E())})),r}function k(){return t.expect("@"),{type:c.Command,value:a(/\d+/)}}function L(){var e;return t.expect("("),e=o.parse(t),t.expect(")"),e.variables.forEach(function(t){if("_"===t.charAt(0))throw new SyntaxError("A variable in directives should not be started with '_': "+t)}),{type:c.Expression,expr:e.expr,variables:e.variables}}function E(){switch(t.peek()){case"c":case"d":case"e":case"f":case"g":case"a":case"b":return p();case"[":return h();case"r":return l();case"o":return d();case"<":return x(1);case">":return x(-1);case"l":return v();case"q":return _();case"t":return y();case"v":return m();case"$":return b();case"/":return g();case"@":return k()}t.throwUnexpectedToken()}function A(){var r=[];return e("",function(){var i=[];e(";",function(){n(i,E())}),r.push(i),t.match(";")&&t.next()}),r}return A()}var i=t("./scanner"),o=t("./expr-parser"),c=t("./syntax");e.exports.parse=function(t){return r(new i(t))}},{"./expr-parser":4,"./scanner":11,"./syntax":12}],10:[function(t,e){"use strict";function n(t,e){return t[i]-e[i]}function r(t,e){u.call(this),this._index=0,this._parent=t,this._shared=t,this._nodes=s.compile(this,e),this._sched=[],this._currentTimeIncr=0}var i=0,o=1,c=t("./extend"),u=t("./emitter"),s=t("./mml-compiler");c(r,u),r.prototype._init=function(t,e){this._currentTimeIncr=e;var n=function(t){for(var e=t+this._currentTimeIncr,r=this._nodes;this._index<r.length&&e>t;)t=r[this._index](this,t),this._index+=1;this._index<r.length&&this.sched(t,n)}.bind(this);n(t)},r.prototype._process=function(t){for(var e=t+this._currentTimeIncr,n=this._sched;n.length&&n[0][i]<e;){var r=n.shift();r[o](r[i])}},r.prototype._recv=function(t,e){e=e||{},"sched"===t.type&&this.sched(t.when,t.callback),e.private||this.emit(t.type,t),e.bubble&&this._parent&&this._parent._recv(t)},r.prototype.sched=function(t,e){return this._sched.push([t,e]),this._sched.sort(n),this},e.exports=r},{"./emitter":2,"./extend":5,"./mml-compiler":7}],11:[function(t,e){"use strict";function n(t){function e(){return p>h}function n(){return t.charAt(h)}function r(){return t.charAt(h++)}function i(e){return e.test?e.test(t.charAt(h)):t.charAt(h)===e}function o(t){i(t)||f(),h+=1}function c(e){var n=e.exec(t.substr(h));return n&&0===n.index?(n=n[0],h+=n.length):n=null,n}function u(){for(;e();){var n=t.charCodeAt(h),r=t.charCodeAt(h+1);if(32===n||9===n)h+=1;else if(10===n)h+=1,l+=1,d=h;else if(47===n&&47===r)s();else{if(47!==n||42!==r)break;a()}}}function s(){for(h+=2;e();)if(10===t.charCodeAt(h++)){l+=1,d=h;break}}function a(){var n=1;for(h+=2;e();){var r=t.charCodeAt(h++),i=t.charCodeAt(h);if(10===r)l+=1,d=h;else if(47===r&&42===i)h+=1,++n;else if(42===r&&47===i&&(h+=1,0===--n))return void(h+=1)}f()}function f(){var t=n(),e="Unexpected token"+(t?": '"+t+"'":" ILLEGAL"),r=new SyntaxError(e);throw r.index=h,r.lineNumber=l,r.column=h-d+(t?1:0),r}t=String(t);var p=t.length,h=0,l=p?1:0,d=0;return{hasNext:e,peek:n,next:r,match:i,expect:o,scan:c,forward:u,throwUnexpectedToken:f}}e.exports=n},{}],12:[function(t,e){"use strict";e.exports={Expression:-1,Begin:0,Note:1,Octave:2,OctaveShift:3,Length:4,Quantize:5,Tempo:6,Velocity:7,InfLoop:8,LoopBegin:9,LoopExit:10,LoopEnd:11,Command:12,End:99}},{}]},{},[1])(1)});